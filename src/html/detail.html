<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <link rel="stylesheet" href="../css/reset.css">
  <link rel="stylesheet" href="../iconfont/iconfont.css">
  <link rel="stylesheet" href="../css/detail.css">
  <link rel="stylesheet" href="../css/swiper-bundle.min.css">
  <script src="../js/jquery.3.5.1.js"></script>
</head>

<body style="height: 3000px;">
  <!-- 列表页头部 -->
  <div class="wrap">
    <div class="container fix_clear">
      <div class="wrap_toolbar fl">
        <a href="javascript:;">小米商城</a><span>|</span>
        <a href="javascript:;">MIUI</a><span>|</span>
        <a href="javascript:;">loT</a><span>|</span>
        <a href="javascript:;">云服务</a><span>|</span>
        <a href="javascript:;">小米</a><span>|</span>
        <a href="javascript:;">小米</a><span>|</span>
        <a href="javascript:;">小爱开放平台</a><span>|</span>
        <a href="javascript:;">小米商城</a><span>|</span>
        <a href="javascript:;">小米商城</a><span>|</span>
        <a href="javascript:;" class="lowdown">下载app
          <span class="code">
            <img src="../images/app.png" alt="">
            <p>小米商城</p>
          </span>
        </a><span>|</span>
        <a href="javascript:;">小米商城</a><span>|</span>
        <a href="javascript:;">智能生活</a><span>|</span>
        <a href="javascript:;">Select Location</a>
      </div>
      <div class="shopping fr">
        <a href="javascript:;">
          <i class="iconfont icon-gouwucheman"></i>
          <span>|</span>
          <em>购物车</em>
          <span>|</span>
          <span>(0)</span>
        </a>
        <div class="tips">
          购物车中还没商品，赶紧选购吧！
        </div>
      </div>
      <div class="jump fr">
        <a href="login.html" class="login">登录</a>
        <span>|</span>
        <a href="register.html" class="register">注册</a>
        <span>|</span>
        <a href="javascript:;">消息通知</a>
      </div>
    </div>
  </div>
  <!-- main主体部分 -->
  <!-- main主体部分 -->
  <div class="main">
    <div class="container ">
      <!-- 小米主体导航条部分 -->
      <div class="main_tab fix_clear">
        <h1 class="logo fl">
          <!-- <a href="./shouye.html"></a> -->

          <!-- <img src="../images/mi-logo.png" alt=""> -->
        </h1>
        <div class="main_nav fl">
          <span href="javascript:;">全部商品分类</span>
          <a href="javascript:;">小米手机</a>
          <a href="javascript:;">小米手机</a>
          <a href="javascript:;">电视</a>
          <a href="javascript:;">笔记本</a>
          <a href="javascript:;">家电</a>
          <a href="javascript:;">路由器</a>
          <a href="javascript:;">小米手机</a>
          <a href="javascript:;">服务</a>
          <a href="javascript:;">社区</a>
        </div>
        <div class="find fr">
          <input type="search" placeholder="手机" class="search">
          <button class="sub_btn">
            <i class="iconfont icon-magnifier
          "></i>
          </button>
        </div>

      </div>

    </div>
  </div>
  <div class="box">
    <div class="container">
      <ul>
        <!-- <li>
        <div>
          <img src="../images/conten.jpg" alt="">
        </div>
        <h4 class="box_tit">收到货第十四</h4>
        <p class="price">5299<span>元起</span></p>
      </li>
      -->
      </ul>
    </div>
  </div>
  <!-- 吸顶导航条 -->
  <div class="nav_bar">
    <div class="container fix_clear">
      <h3 class="con_tit fl">Redmi K30 至尊纪念版</h3>
      <div class="con_left fl">
        <span>|</span>
        <a href="">Redmi K30系列</a>
      </div>
      <div class="con_right fr">
        <a href="">概述</a>
        <span>|</span>
        <a href="">参数</a>
        <span>|</span>
        <a href="">顺利打开</a>
        <span>|</span>
        <a href="">打开附件</a>
        <span>|</span>
        <a href="">速度快是</a>
      </div>
    </div>
  </div>
  <!-- 提示信息 -->
  <p class="tips">
    <span>为了方便您的购买，请提前登录</span>
    <a href="login.html" class="now">立即登录</a>
    <a href="javascript:;"><em class="del">&times;</em></a>
  </p>
  <!-- 商品详情信息 -->
  <div class="commodity">
    <!-- <div class="container fix_clear"> -->
    <!-- 左侧轮播图部分 -->
    <!-- <div class="commodity_l fl">
        <div class="swiper-container">
          <div class="swiper-wrapper">
            <div class="swiper-slide">
              <img src="../images/detail1.jpg" alt="">
            </div>
            <div class="swiper-slide">
              <img src="../images/detail2.jpg" alt="">
            </div>
            <div class="swiper-slide">
              <img src="../images/detail3.jpg" alt="">
            </div>
            <div class="swiper-slide">
              <img src="../images/detail4.jpg" alt="">
            </div>
            <div class="swiper-slide">
              <img src="../images/detail5.jpg" alt="">
            </div>
          </div>
          <div class="swiper-button-prev arror"></div>
          <div class="swiper-button-next arror"></div>
          <div class="swiper-pagination"></div>
        </div>
      </div> -->
    <!-- 右侧商品信息部分 -->
    <!-- <div class="commodity_r fl">
        <h3 class="tit">
          Redmi K30 至尊纪念版
        </h3>
        <p class="desc">
          <font>「128GB版本10月13号上午10点开售，购机抽奖赢70英寸电视」</font>
          120Hz弹出全面屏 / 天玑1000+旗舰处理器 / 索尼6400万四摄 / 立体声双扬声器 / 4500mAh+33W闪充 / 双模5G / 多功能NFC / 线性震动马达 / 红外遥控
        </p>
        <p class="company_info">小米自营</p>
        <p class="price_info">
          <span>2199元</span><em class="oldprice">3000</em>
        </p>
        <div class="line"></div>
        <div class="subscribe_info fix_clear">
          <div class="subscribe_l fl">
            <span class="name">预约中</span>
            <span class="price">
              <em class="sign">￥</em>2199</span>
          </div>
          <div class="subscribe_r fr">
            <span class="time">
              <span class="over">
                距结束
              </span>
              <span class="days">
                
              </span>
              <span class="hours"></span>
              :
              <span class="minutes"></span>
              :
              <span class="seconds"></span>

            </span>
          </div>
        </div>
        <div class="choice">
          <h4 class="color">
            选择颜色
          </h4>
          <ul class="fix_clear">
            <li class="all"><a href="">极夜黑</a></li>
            <li class="all"><a href="">月牙白</a></li>
            <li class="all"><a href="">柠檬绿</a></li>
          </ul>
        </div>
        <div class="edition">
          <h4 class="edition_tit">
            选择版本
          </h4>
          <ul class="fix_clear">
            <li class="all"><a href="">8GB+128GB</a></li>
            <li class="all"><a href="">6GB+128GB</a></li>
            <li class="all"><a href="">8GB+512GB</a></li>
          </ul>
        </div>
        <ul class="list">
          <li>
            <div class="fix_clear">
              <span class="list_tit fl"><i>Redmi K30 至尊纪念版 </i><i class="neicun">8GB+128GB</i> <i class="choice_color">薄荷绿</i></span>
              <em class="fr">2199元</em>
            </div>
            <div class="total_price">总计：2199元</div>
          </li>
        </ul>
        <a href="" class="addCar ">加入购物车</a>
        <a href="" class=" last">去购物车</a>
      </div> -->
    <!-- </div> -->
  </div>
  <script src="../js/jquery.cookie.js"></script>
  <script src="../js/swiper-bundle.min.js"></script>
  <script>
    //logo切换跳转页面
    $('.logo').click(function () {
      location.href = "./index.html"
    })
    // main 主体导航条部分
    let arr;
    $.get('../data/main.json', function (data) {

      $('.main_nav a:lt(7)').hover(function () {

        $('.box').stop().slideDown();
        let idx = $(this).index();

        switch (idx) {
          case 1:
            arr = data.slice(0, 5);
            break;
          case 2:
            arr = data.slice(5, 11);
            break;
          case 3:
            arr = data.slice(11, 17);
            break;
          case 4:
            arr = data.slice(17, 23);
            break;
          case 5:
            arr = data.slice(23, 29);
            break;
          case 6:
            arr = data.slice(29, 35);
            break;
          case 7:
            arr = data.slice(35, 41);
            break;
        }

        $('.box ul').html(arr.map(ele => `
            <li>
                <div>
                  <img src="${ele.img}" alt="">
                </div>
                <h4 class="box_tit">${ele.title}</h4>
                <p class="price">${ele.price}<span>元起</span></p>
            </li>`
        ).join(''))
      }, function () {
        $('.box').stop().slideUp("slow");
      })
    });

    $('.box').hover(function () {
      $(this).stop().slideDown();
    }, function () {
      $(this).stop().slideUp('slow');
    })
    // 提示信息
    $('.del').click(function () {
      $(this).parent().parent().remove();
    })
    // 商品详情信息 轮播图部分

    // // 倒计时部分
    //   let daysEle = document.querySelector('.days');
    //   let hoursEle = document.querySelector('.hours');
    //   let minutes = document.querySelector('.minutes');
    //   let seconds = document.querySelector('.seconds');

    //   // let t = 1601783170055 + 14400000 - 10800000 - 3000000 - 360000 - 60000;（检验4小时之后还是否重复4小时）
    //   let t = 1601904350394 + 604800000;

    //   function  getTime(){
    //     let time = parseInt((t - Date.now())/1000);

    //     let days = parseInt(time/60/60/24)
    //     console.log(days);  
    //     let hours =parseInt( time / 3600 )% 24 ;
    //     let minute = parseInt(time % 3600 / 60);
    //     let second = time % 60 ;
    //     // 封装的函数如果没有返回值，就会得到undefined
    //     daysEle.innerHTML = days + '天';
    //     hoursEle.innerHTML =toTen(hours);
    //     minutes.innerHTML = toTen(minute);
    //     seconds.innerHTML = toTen(second);

    //   }

    //   function toTen(num){
    //   return  num < 10 ? '0'+num : num
    //   }
    //   getTime()
    //   setInterval(function(){
    //     getTime();
    //   },1000)

    // 商品信息渲染
    class DetailRender {
      constructor(selector) {
        this.ele = document.querySelector(selector);
        // 商品ID
        this.goodsId = location.search.split("=")[1];
        // 定义一个数据
        this.data = null;
        this.login = false; // 表示用户是否登录， 默认是没登录
        this.t = 1601904350394 + 604800000;
        this.init();

      }
      init() {
        this.getData(this.goodsId);
        this.isLogin();

      }
      // 获取详情页需要渲染的数据
      getData(goodsId) {
        $.get('../data/detail.json', data => {
          // 过滤相同商品的id和数据的id出来
          this.data = data.filter(ele => ele.id == goodsId);
          // console.log(this.data);
          // 把得到的数据传给负责页面详情的数据渲染
          this.render(this.data[0]);
        })
      }
      // 负责详情页的数据渲染
      render(data) {
        // console.log(data);
        let html = `<div class="container fix_clear">
          <div class="commodity_l fl">
            <div class="swiper-container">
              <div class="swiper-wrapper">${this.renderSwiper(data.imgs)}</div>
              <div class="swiper-button-prev arror"></div>
              <div class="swiper-button-next arror"></div>
              <div class="swiper-pagination"></div>
            </div>
          </div>
          <div class="commodity_r fl">
            <h3 class="tit">${data.title}</h3>
            <p class="desc"><font>${data.font}</font>${data.desc}</p>
            <p class="company_info">小米自营</p>
            <p class="price_info">
              <span class="same">${data.allcount}</span>元<em class="oldprice">${data.oldprice ? data.oldprice : ""}</em>
            </p>
            <div class="line"></div>
            <div class="subscribe_info fix_clear">
              <div class="subscribe_l fl">
                <span class="name">预约中</span>
                <span class="price">
                  <em class="sign">￥</em><em class="same">${data.allcount}</em>元</span>
              </div>
              <div class="subscribe_r fr">
                <span class="time">
                  <span class="over">距结束</span>
                  <span class="days">0天</span>
                  <span class="hours">00</span> :
                  <span class="minutes">00</span> :
                  <span class="seconds">00</span>
                </span>
              </div>
            </div>
            <div class="choice">
              <h4 class="color">
                选择颜色
              </h4>
              <ul class="fix_clear">${this.renderColor(data.color)}</ul>
            </div>
            <div class="edition">
              <h4 class="edition_tit">
                选择版本
              </h4>
              <ul class="fix_clear">${this.renderEdition(data.service)}</ul>
            </div>
            <ul class="list">
              <li>
                <div class="fix_clear">
                  <span class="list_tit fl"><i>${data.list_tit}</i> <i class="neicun">${data.list_neicun}</i> <i class="choice_color">${data.list_color}</i></span>
                  <em class="fr"><i class="same">${data.allcount}</i><i>元</i></em>
                </div>
                <div class="total_price">总计：<em class="same">${data.allcount}</em>元</div>
              </li>
            </ul>
            <a href="javascript:;" class="addCar">加入购物车</a>
            <a href="javascript:;" class="last">去购物车</a>
          </div>
        </div>`;
        this.ele.innerHTML = html;
        this.initSwiper();
        this.renderCountDown();
        this.addEvent();
      }
      // 负责渲染轮播图
      renderSwiper(imgs) {
        return imgs.map(img => `<div class="swiper-slide">
          <img src="${img}" alt="">
        </div>`).join("");

      }
      // 渲染颜色
      renderColor(color) {
        // 默认选中第一个
        return color.map((c, i) => `<li class="all">
          <a href="Javascript:;" class="${ i == 0 ? 'active' : ''}">${c}</a>
        </li>`).join("");
      }
      // 渲染版本
      renderEdition(edition) {
        // 默认选中第一个版本
        return edition.map((ed, i) => `<li class="all">
          <a href="javascript:;" class="${ i == 0 ? 'active' : ''}" data-price=${ed.price}>${ed.neicun}</a>
        </li>`).join("")
      }
      // 初始化轮播图
      initSwiper() {
        this.mySwiper = new Swiper('.swiper-container', {
          autoplay: true,//可选选项，自动滑动
          loop: true,
          navigation: {
            nextEl: '.swiper-button-next',
            prevEl: '.swiper-button-prev',
          },
          pagination: {
            el: '.swiper-pagination',
            bulletClass: 'my-bullet',
            bulletActiveClass: 'active',
          },
        });
      }
      // 渲染倒计时
      renderCountDown() {
        this.daysEle = this.ele.querySelector('.days');
        this.hoursEle = this.ele.querySelector('.hours');
        this.minutes = this.ele.querySelector('.minutes');
        this.seconds = this.ele.querySelector('.seconds');
        this.getTime();
        setInterval(() => this.getTime(), 1000);
      }
      // 数字倒计时补零
      toTen(num) {
        return num < 10 ? '0' + num : num
      }
      // 将时间戳转换为 天时分秒
      getTime() {
        let time = parseInt((this.t - Date.now()) / 1000);
        let days = parseInt(time / 60 / 60 / 24)
        let hours = parseInt(time / 3600) % 24;
        let minute = parseInt(time % 3600 / 60);
        let second = time % 60;

        this.daysEle.innerHTML = days + '天';
        this.hoursEle.innerHTML = this.toTen(hours);
        this.minutes.innerHTML = this.toTen(minute);
        this.seconds.innerHTML = this.toTen(second);
      }
      // 判断用户是否登录
      isLogin(){
        let user = $.cookie('users');
        let pwd = $.cookie('pwd');
        if (user && pwd) {
          $.post('../../api/login.php', { user, pwd }, data => {
            // if (data.err === 0) {
            //   this.login = true;
            // } else {
            //   this.login = false;
            // }
         this.login = !data.err
          }, 'json')
        }

      }
      // 添加事件，处理元素交互效果
      addEvent() {
        let choiceColor = this.ele.querySelector('.choice_color');
        let neicun = this.ele.querySelector('.neicun');
        let sames = this.ele.querySelectorAll('.same');
        // console.log(sames)
        // console.log(this)
        // 点击颜色得到的数据
        $('.choice a').click(function () {
          $('.choice a').removeClass('active');
          $(this).addClass('active');
          let text = $(this).text();
          $(choiceColor).html(text);
        })
        // 点击版本得到的数据
        $('.edition a').click(function () {
          $('.edition a').removeClass('active');
          let price = $(this).attr('data-price');

          $(this).addClass('active');
          let text = $(this).text();
          $(neicun).html(text);
          sames.forEach(ele => {

            ele.innerHTML = price;
          })
        })
        //点击购物车判断是否已登录
        $('.addCar').click(()=> {
          if(this.login){
            alert("登录的")
            // 如果我只是渲染购物车页面，可以使用简单的JSON文件作为数据就行
            // 因为我们需要对购物车做增删改查操作，而前端无法操作文件
            // 1. 前端获取数据库中所有字段的值
            console.log(this.data);
            //    1.1 商品ID, 商品图片, 描述, 价格, 数量
            //      id: 1,
            //      imgs: [],
            //      desc (list_tit): Redmi K30 至尊纪念版 8GB+128GB 极夜黑
            //      price (same): 2499
            //      num: 1
            // 2.发送请求给后端
            //    2.1 把以上获取的数据统统使用参数发给后端

            // 3. 后端书写接口 （类似于验证用户名是否已存在）
            //    3.0 接受前端发送的数据
            //    3.1 使用前端发送的数据，将其插入 数据库中的shoppingcar 表中
            //          3.1.1 如果该商品已经在购物车表中存在，那么我们不会添加两个同样的商品
            //                  怎么知道商品是否已经在购物车表中，
            //                  通过商品的ID去判断， 具体就是查询购物车表中是否存在该商品的ID
            //          3.1.2 我们应该选择修改该商品的数量
            //          3.1.3 如果商品不存在，
            //                  我们将该商品的数据全部插入数据库作为一条新数据
            //    3.2 如果更新数据成功
            //        3.2.1 不管是插入整个数据成功，还是修改商品数量成功
            //    3.3 返回数据给前端通知加入购物车成功
            //    3.4 否则就是加入购物车失败
            
            // 4. 前端接受后端返回的数据
            //    4.1 判断后端返回的数据是成功还是失败
            //    4.2 成功就提示用户加入购物车成功，然后跳转到购物车页面 
            //    4.3 失败就提示用户加入购物车失败，请重试
            console.log(this.data)
             let shop = this.data[0];
             let id = shop.id;
             let imgSrc = shop.imgs[0];
             let desc = this.ele.querySelector('.list_tit').innerText;
             console.log(desc)
             let price = this.ele.querySelector('.same').innerText;
            //  console.log(id,imgSrc,desc,price,num)
             $.get('../../api/detail.php',{id,imgSrc,desc,price},function(data){
                if(data.err === 0){
                  alert(data.msg)
                }else{
                  alert(data.msg)
                }
             },'json')

          }else{
            confirm('您还没登录，即将跳到登录页');
          }

        })
        $('.last').click(()=>{
          if(this.login){
            location.href = './shopping.html'
          }else{
            alert('即将跳转到登录页');
            location.href="./login.html"
          }
        })
      }
      
    }
    new DetailRender('.commodity');

  </script>
</body>

</html>